# CryptoBot Auction System

Реализация системы аукционов цифровых товаров, аналогичной Telegram Gift Auctions, для конкурса Backend-разработчиков от CryptoBot.

## Понимание механики Telegram Gift Auctions

Telegram Gift Auctions — это многораундовая система аукционов на лимитированные цифровые подарки. В отличие от классических аукционов с одним дедлайном, здесь используется механизм последовательных раундов, где в каждом раунде часть участников получает товар, а остальные продолжают участие в следующих раундах.

### Ключевые особенности механики

#### 1. Многораундовая система
- Аукцион состоит из нескольких раундов
- В каждом раунде разыгрывается фиксированное количество товаров (`itemsPerRound`)
- Общее количество товаров (`totalItems`) распределяется по раундам
- Количество раундов = `ceil(totalItems / itemsPerRound)`

#### 2. Раунды и тайминги
- Каждый раунд имеет фиксированную длительность (`roundDuration` в секундах)
- Раунд начинается сразу после завершения предыдущего (или при старте аукциона)
- Раунд завершается автоматически по истечении времени

#### 3. Ставки и ранжирование
- Участники могут делать ставки в течение активного раунда
- Один участник может делать несколько ставок в раунде
- Для ранжирования учитывается **максимальная ставка** каждого участника в раунде
- При равенстве сумм приоритет отдаётся более ранней ставке (FIFO)

#### 4. Определение победителей
- Победители определяются по убыванию суммы ставки
- Количество победителей = `itemsPerRound`
- Победители получают товар и их ставки списываются
- Проигравшие ставки автоматически переносятся в следующий раунд в исходном размере
- Если ставка ни разу не вошла в топ за все раунды, деньги возвращаются в конце аукциона

#### 5. Anti-sniping механизм
- Раунд продлевается ТОЛЬКО если ставка входит в топ (топ-N, где N = `itemsPerRound`)
- Если ставка в топе размещается в последние N секунд раунда (`antiSnipingWindow`), раунд автоматически продлевается на N секунд
- Это предотвращает "снайперские" ставки в последнюю секунду только для ставок, которые реально влияют на результат
- Механизм срабатывает только для ставок, попадающих в топ победителей

#### 6. Работа с балансами
- При размещении ставки средства сразу списываются с баланса пользователя
- Если пользователь проиграл раунд, ставка автоматически переносится в следующий раунд (деньги НЕ возвращаются)
- Если пользователь выиграл, средства остаются списанными (оплата за товар)
- Дополнительные ставки победителей (кроме максимальной) возвращаются сразу
- Если ставка ни разу не вошла в топ за все раунды аукциона, деньги возвращаются в конце
- Все транзакции логируются для аудита

### Принятые допущения

1. **Максимальная ставка в раунде**: Если пользователь делает несколько ставок в раунде, для ранжирования учитывается только максимальная ставка.

2. **Перенос ставок**: Проигравшие ставки автоматически переносятся в следующий раунд в исходном размере (по механике Telegram Gift Auctions).

3. **Возврат средств**: Возврат происходит только в двух случаях:
   - Дополнительные ставки победителей (кроме максимальной)
   - Ставки, которые ни разу не вошли в топ за все раунды аукциона (возврат в конце)

4. **Завершение раунда**: Раунд завершается автоматически по истечении времени. Ручное завершение также возможно через API.

5. **Конкурентность**: Система использует MongoDB транзакции для обеспечения атомарности операций со ставками и балансами.

6. **Anti-sniping**: Механизм продлевает раунд ТОЛЬКО если ставка входит в топ победителей (топ-N, где N = `itemsPerRound`).

## Архитектурные решения

### Технологический стек
- **Backend**: Node.js + TypeScript
- **База данных**: MongoDB
- **Фреймворк**: Express.js
- **Валидация**: express-validator
- **Логирование**: Winston
- **Планировщик задач**: node-cron

### Структура проекта

```
cryptobotcompetition/
├── src/
│   ├── models/          
│   │   ├── User.ts     
│   │   ├── Auction.ts   
│   │   └── Transaction.ts 
│   ├── services/        
│   │   ├── UserService.ts
│   │   └── AuctionService.ts
│   ├── controllers/    
│   │   ├── UserController.ts
│   │   └── AuctionController.ts
│   ├── routes/          
│   │   ├── userRoutes.ts
│   │   └── auctionRoutes.ts
│   ├── middleware/     
│   │   └── errorHandler.ts
│   ├── config/         
│   │   ├── database.ts
│   │   └── logger.ts
│   ├── jobs/            
│   │   └── roundProcessor.ts 
│   ├── scripts/         
│   │   └── loadTest.ts  
│   └── server.ts        
├── public/              
│   ├── index.html
│   ├── styles.css
│   └── app.js
├── docker-compose.yml
├── Dockerfile
└── README.md
```

### Основные компоненты

#### 1. Модели данных

**User**: Хранит информацию о пользователях и их балансах
- `userId`: Уникальный идентификатор пользователя
- `balance`: Текущий баланс
- `username`: Имя пользователя (опционально)

**Auction**: Хранит информацию об аукционах
- Параметры аукциона (название, описание, количество товаров и т.д.)
- Массив раундов (`rounds`)
- Массив ставок (`bids`)
- Текущий статус и раунд

**Transaction**: Логирует все финансовые операции
- Тип транзакции (bid, refund, win, deposit)
- Статус транзакции
- Связь с аукционом и ставкой

#### 2. Сервисы

**AuctionService**: Основная бизнес-логика аукционов
- Создание и запуск аукционов
- Размещение ставок с anti-sniping
- Завершение раундов и определение победителей
- Возврат средств проигравшим

**UserService**: Управление пользователями
- Создание/получение пользователей
- Управление балансами
- История транзакций

#### 3. Фоновые задачи

**RoundProcessor**: Cron-задача, которая каждые 5 секунд проверяет активные раунды и автоматически завершает истёкшие.

### API Endpoints

#### Аукционы
- `POST /api/auctions` - Создать аукцион
- `GET /api/auctions` - Получить все аукционы
- `GET /api/auctions/active` - Получить активные аукционы
- `GET /api/auctions/:id` - Получить аукцион по ID
- `POST /api/auctions/:id/start` - Запустить аукцион
- `POST /api/auctions/:id/bid` - Разместить ставку
- `POST /api/auctions/:id/complete-round` - Завершить раунд вручную
- `GET /api/auctions/:id/round/:roundNumber/leaderboard` - Получить топ ставок раунда
- `GET /api/auctions/:id/user/:userId/bids` - Получить ставки пользователя

#### Пользователи
- `GET /api/users/:userId` - Получить пользователя
- `POST /api/users/:userId` - Создать/обновить пользователя
- `GET /api/users/:userId/balance` - Получить баланс
- `POST /api/users/:userId/deposit` - Пополнить баланс
- `GET /api/users/:userId/transactions` - История транзакций

### Обработка конкурентности

1. **Атомарные операции**: Использование MongoDB транзакций для операций со ставками и балансами
2. **Валидация баланса**: Проверка баланса перед списанием средств
3. **Блокировки**: Использование индексов MongoDB для предотвращения дублирования ставок
4. **Cron-задачи**: Автоматическое завершение раундов предотвращает конфликты при ручном управлении

### Финансовая корректность

1. **Транзакции**: Все операции с деньгами логируются в таблице `Transaction`
2. **Возвраты**: Проигравшие участники автоматически получают возврат средств (если ставка ни разу не вошла в топ)
3. **Балансы**: Балансы пользователей всегда актуальны благодаря атомарным операциям
4. **Аудит**: Полная история всех финансовых операций доступна через API

## Инструкции по запуску

### Требования
- Node.js 20+
- MongoDB 7.0+
- Docker и Docker Compose (опционально)

### Запуск через Docker (рекомендуется)

1. **Клонировать репозиторий**
```bash
git clone https://github.com/coder-od1no4ka/cryptobotcompetition.git
cd cryptobotcompetition
```

2. **Запустить проект**
```bash
docker-compose up -d
```

3. **Открыть в браузере**
```
http://localhost:3000
```

4. **Остановить проект**
```bash
docker-compose down
```

### Локальный запуск

1. **Установить зависимости**
```bash
npm install
```

2. **Запустить MongoDB** (должен быть доступен на `localhost:27017`)

3. **Собрать проект**
```bash
npm run build
```

4. **Запустить сервер**
```bash
npm start

npm run dev
```

5. **Открыть в браузере**
```
http://localhost:3000
```

### Первые шаги

1. **Создать пользователя**
   - Перейдите на вкладку "Мой профиль"
   - Введите User ID (например, `user1`)
   - Нажмите "Загрузить профиль"
   - Пополните баланс (например, 1000)

2. **Создать аукцион**
   - Перейдите на вкладку "Создать аукцион"
   - Заполните форму и нажмите "Создать аукцион"

3. **Сделать ставку**
   - Перейдите на вкладку "Аукционы"
   - Найдите созданный аукцион
   - Введите сумму ставки и нажмите "Ставка"

4. **Запустить ботов для тестирования**
   - Перейдите на вкладку "Боты"
   - Введите ID аукциона (скопируйте из карточки аукциона)
   - Настройте количество ботов и интервал
   - Нажмите "Запустить ботов"
